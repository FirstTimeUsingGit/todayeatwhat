<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>食譜管理 App</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body className="bg-gray-100 min-h-screen">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [ingredients, setIngredients] = useState([]);
      const [recipes, setRecipes] = useState([]);
      const [page, setPage] = useState('home');
    const API_URL = 'https://todayeatwhat-backend.vercel.app';
      // 獲取數據
      useEffect(() => {
        const fetchData = async () => {
          try {
            const response = await fetch(`${API_URL}/data`);
            const jsonData = await response.json();
            setIngredients(jsonData.ingredients || []);
            setRecipes(jsonData.recipes || []);
          } catch (error) {
            console.error('獲取數據失敗:', error);
          }
        };
        fetchData();
      }, []);

      // 保存數據
      const saveData = async (updatedIngredients, updatedRecipes) => {
        try {
          await fetch(`${API_URL}/data`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredients: updatedIngredients, recipes: updatedRecipes }),
          });
          setIngredients(updatedIngredients);
          setRecipes(updatedRecipes);
        } catch (error) {
          console.error('保存數據失敗:', error);
        }
      };

      const addIngredient = (newIngredient) => {
        const updatedIngredients = [...ingredients, { id: Date.now(), ...newIngredient }];
        saveData(updatedIngredients, recipes);
      };

      const deleteIngredient = (id) => {
        const updatedIngredients = ingredients.filter(ing => ing.id !== id);
        saveData(updatedIngredients, recipes);
      };

      const addRecipe = (newRecipe) => {
        const updatedRecipes = [...recipes, { id: Date.now(), ...newRecipe }];
        saveData(ingredients, updatedRecipes);
      };

      const deleteRecipe = (id) => {
        const updatedRecipes = recipes.filter(recipe => recipe.id !== id);
        saveData(ingredients, updatedRecipes);
      };

      const getFilteredRecipes = (filters) => {
        return recipes.filter(recipe => {
          const recipeIngredients = ingredients.filter(ing => recipe.ingredients.includes(ing.id));
          return (
            (!filters.ingredient || recipe.ingredients.includes(filters.ingredient)) &&
            (!filters.season || recipeIngredients.some(ing => ing.season === filters.season)) &&
            (!filters.cookingMethod || recipeIngredients.some(ing => ing.cookingMethods.includes(filters.cookingMethod))) &&
            (!filters.type || recipeIngredients.some(ing => ing.type === filters.type))
          );
        });
      };

      const getRandomRecipe = () => {
        return recipes[Math.floor(Math.random() * recipes.length)];
      };

      return (
        <div className="container mx-auto p-6 max-w-4xl bg-white shadow-lg rounded-lg mt-6">
          <nav className="mb-6 flex justify-center space-x-4">
            <button className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-200" onClick={() => setPage('home')}>首頁</button>
            <button className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-200" onClick={() => setPage('editIngredients')}>編輯材料</button>
            <button className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-200" onClick={() => setPage('editRecipes')}>編輯菜單</button>
            <button className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-200" onClick={() => setPage('whatToEat')}>唔知食乜好</button>
          </nav>

          {page === 'home' && (
            <div className="text-center">
              <h1 className="text-3xl font-bold text-gray-800 mb-4">歡迎使用食譜管理 App</h1>
              <p className="text-gray-600">管理您嘅食材同菜單，仲有隨機推薦功能！</p>
            </div>
          )}

          {page === 'editIngredients' && (
            <EditIngredients ingredients={ingredients} addIngredient={addIngredient} deleteIngredient={deleteIngredient} />
          )}

          {page === 'editRecipes' && (
            <EditRecipes recipes={recipes} ingredients={ingredients} addRecipe={addRecipe} deleteRecipe={deleteRecipe} />
          )}

          {page === 'whatToEat' && (
            <WhatToEat recipes={recipes} ingredients={ingredients} getFilteredRecipes={getFilteredRecipes} getRandomRecipe={getRandomRecipe} />
          )}
        </div>
      );
    };

    const EditIngredients = ({ ingredients, addIngredient, deleteIngredient }) => {
      const [name, setName] = useState('');
      const [type, setType] = useState('');
      const [season, setSeason] = useState('');
      const [cookingMethods, setCookingMethods] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');

      const handleSubmit = () => {
        if (name && type && season && cookingMethods.length > 0) {
          addIngredient({ name, type, season, cookingMethods });
          setName(''); setType(''); setSeason(''); setCookingMethods([]);
        }
      };

      const filteredIngredients = ingredients.filter(ing =>
        ing.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ing.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ing.season.toLowerCase().includes(searchTerm.toLowerCase()) ||
        ing.cookingMethods.some(method => method.toLowerCase().includes(searchTerm.toLowerCase()))
      );

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-800 mb-4">編輯材料</h2>
          <div className="mb-6 bg-gray-50 p-4 rounded-lg shadow">
            <input className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value={name} onChange={(e) => setName(e.target.value)} placeholder="材料名稱" />
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value={type} onChange={(e) => setType(e.target.value)}>
              <option value="">選擇種類</option>
              {['肉類', '蔬菜', '蛋', '海鮮', '豆類', '其他'].map(t => <option key={t} value={t}>{t}</option>)}
            </select>
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value={season} onChange={(e) => setSeason(e.target.value)}>
              <option value="">選擇季節</option>
              {['春', '夏', '秋', '冬', '四季'].map(s => <option key={s} value={s}>{s}</option>)}
            </select>
            <div className="mb-2">
              {['蒸', '炒', '煮', '炸', '湯', '麵'].map(method => (
                <label key={method} className="inline-flex items-center mr-4">
                  <input type="checkbox" className="form-checkbox h-5 w-5 text-blue-600" checked={cookingMethods.includes(method)} onChange={(e) => {
                    if (e.target.checked) setCookingMethods([...cookingMethods, method]);
                    else setCookingMethods(cookingMethods.filter(m => m !== method));
                  }} />
                  <span className="ml-2 text-gray-700">{method}</span>
                </label>
              ))}
            </div>
            <button className="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition duration-200" onClick={handleSubmit}>保存</button>
          </div>
          <div className="mb-4">
            <input
              className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="搜尋材料..."
            />
          </div>
          <table className="table-auto w-full border-collapse border border-gray-300">
            <thead>
              <tr className="bg-gray-200">
                <th className="border px-4 py-2">材料名稱</th>
                <th className="border px-4 py-2">種類</th>
                <th className="border px-4 py-2">季節</th>
                <th className="border px-4 py-2">烹調類型</th>
                <th className="border px-4 py-2">操作</th>
              </tr>
            </thead>
            <tbody>
              {filteredIngredients.map(ing => (
                <tr key={ing.id}>
                  <td className="border px-4 py-2">{ing.name}</td>
                  <td className="border px-4 py-2">{ing.type}</td>
                  <td className="border px-4 py-2">{ing.season}</td>
                  <td className="border px-4 py-2">{ing.cookingMethods.join(', ')}</td>
                  <td className="border px-4 py-2">
                    <button
                      className="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                      onClick={() => deleteIngredient(ing.id)}
                    >
                      刪除
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    const EditRecipes = ({ recipes, ingredients, addRecipe, deleteRecipe }) => {
      const [name, setName] = useState('');
      const [selectedIngredients, setSelectedIngredients] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');

      const handleSubmit = () => {
        if (name && selectedIngredients.length > 0) {
          addRecipe({ name, ingredients: selectedIngredients });
          setName(''); setSelectedIngredients([]);
        }
      };

      const filteredRecipes = recipes.filter(recipe => {
        const recipeIngredients = ingredients.filter(ing => recipe.ingredients.includes(ing.id));
        return (
          recipe.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
          recipeIngredients.some(ing => ing.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
          recipeIngredients.some(ing => ing.season.toLowerCase().includes(searchTerm.toLowerCase())) ||
          recipeIngredients.some(ing => ing.cookingMethods.some(method => method.toLowerCase().includes(searchTerm.toLowerCase())))
        );
      });

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-800 mb-4">編輯菜單</h2>
          <div className="mb-6 bg-gray-50 p-4 rounded-lg shadow">
            <input className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" value={name} onChange={(e) => setName(e.target.value)} placeholder="菜單名稱" />
            <div className="mb-2">
              {ingredients.map(ing => (
                <label key={ing.id} className="inline-flex items-center mr-4">
                  <input type="checkbox" className="form-checkbox h-5 w-5 text-blue-600" checked={selectedIngredients.includes(ing.id)} onChange={(e) => {
                    if (e.target.checked) setSelectedIngredients([...selectedIngredients, ing.id]);
                    else setSelectedIngredients(selectedIngredients.filter(id => id !== ing.id));
                  }} />
                  <span className="ml-2 text-gray-700">{ing.name}</span>
                </label>
              ))}
            </div>
            <button className="px-4 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition duration-200" onClick={handleSubmit}>保存</button>
          </div>
          <div className="mb-4">
            <input
              className="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              placeholder="搜尋菜單..."
            />
          </div>
          <table className="table-auto w-full border-collapse border border-gray-300">
            <thead>
              <tr className="bg-gray-200">
                <th className="border px-4 py-2">菜單名稱</th>
                <th className="border px-4 py-2">材料</th>
                <th className="border px-4 py-2">季節</th>
                <th className="border px-4 py-2">烹調方式</th>
                <th className="border px-4 py-2">操作</th>
              </tr>
            </thead>
            <tbody>
              {filteredRecipes.map(recipe => {
                const recipeIngredients = ingredients.filter(ing => recipe.ingredients.includes(ing.id));
                const seasons = [...new Set(recipeIngredients.map(ing => ing.season))].join(', ');
                const methods = [...new Set(recipeIngredients.flatMap(ing => ing.cookingMethods))].join(', ');
                return (
                  <tr key={recipe.id}>
                    <td className="border px-4 py-2">{recipe.name}</td>
                    <td className="border px-4 py-2">{recipeIngredients.map(ing => ing.name).join(', ')}</td>
                    <td className="border px-4 py-2">{seasons}</td>
                    <td className="border px-4 py-2">{methods}</td>
                    <td className="border px-4 py-2">
                      <button
                        className="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                        onClick={() => deleteRecipe(recipe.id)}
                      >
                        刪除
                      </button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      );
    };

    const WhatToEat = ({ recipes, ingredients, getFilteredRecipes, getRandomRecipe }) => {
      const [filters, setFilters] = useState({});
      const [results, setResults] = useState([]);

      const handleSearch = () => {
        setResults(getFilteredRecipes(filters));
      };

      const handleRandom = () => {
        const randomRecipe = getRandomRecipe();
        setResults(randomRecipe ? [randomRecipe] : []);
      };

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-800 mb-4">唔知食乜好</h2>
          <div className="mb-6 bg-gray-50 p-4 rounded-lg shadow">
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onChange={(e) => setFilters({ ...filters, ingredient: e.target.value || null })}>
              <option value="">選擇材料</option>
              {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
            </select>
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onChange={(e) => setFilters({ ...filters, season: e.target.value || null })}>
              <option value="">選擇季節</option>
              {['春', '夏', '秋', '冬', '四季'].map(s => <option key={s} value={s}>{s}</option>)}
            </select>
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onChange={(e) => setFilters({ ...filters, cookingMethod: e.target.value || null })}>
              <option value="">選擇烹調方式</option>
              {['蒸', '炒', '煮', '炸', '湯', '麵'].map(m => <option key={m} value={m}>{m}</option>)}
            </select>
            <select className="border p-2 rounded w-full mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onChange={(e) => setFilters({ ...filters, type: e.target.value || null })}>
              <option value="">選擇種類</option>
              {['肉類', '蔬菜', '蛋', '海鮮', '豆類', '其他'].map(t => <option key={t} value={t}>{t}</option>)}
            </select>
            <div className="space-x-2">
              <button className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-200" onClick={handleSearch}>搜尋</button>
              <button className="px-4 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition duration-200" onClick={handleRandom}>隨機選取</button>
            </div>
          </div>
          <table className="table-auto w-full border-collapse border border-gray-300">
            <thead>
              <tr className="bg-gray-200">
                <th className="border px-4 py-2">菜單名稱</th>
                <th className="border px-4 py-2">材料</th>
              </tr>
            </thead>
            <tbody>
              {results.map(recipe => {
                const recipeIngredients = ingredients.filter(ing => recipe.ingredients.includes(ing.id));
                return (
                  <tr key={recipe.id}>
                    <td className="border px-4 py-2">{recipe.name}</td>
                    <td className="border px-4 py-2">{recipeIngredients.map(ing => ing.name).join(', ')}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>